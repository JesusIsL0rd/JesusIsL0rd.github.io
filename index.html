<!DOCTYPE html>

<script>
    let Locations = [
        {name:"acpl",id:"1"},
        {name:"beehive",id:"2"},
        {name:"bpl",id:"3"},
        {name:"bridges",id:"4"},
        {name:"brooklyn",id:"5"},
        {name:"broward",id:"6"},
        {name:"cals",id:"7"},
        {name:"cfbc",id:"8"},
        {name:"cvl",id:"9"},
        {name:"chipublib",id:"10"},
        {name:"cincinnatilibrary",id:"11"},
        {name:"clamsnet",id:"12"},
        {name:"ccpl",id:"13"},
        {name:"ohdbks",id:"14"},
        {name:"cwmars",id:"15"},
        {name:"dayton",id:"16"},
        {name:"okvirtuallibrary",id:"17"},
        {name:"phoenix",id:"18"},
        {name:"hcpl",id:"19"},
        {name:"hclib",id:"20"},
        {name:"iddc",id:"21"},
        {name:"kclibrary",id:"22"},
        {name:"kcls",id:"23"},
        {name:"kyunbound",id:"24"},
        {name:"lapl",id:"25"},
        {name:"lacountylibrary",id:"26"},
        {name:"lakeland",id:"27"},
        {name:"lasvegas",id:"28"},
        {name:"lcls",id:"29"},
        {name:"livebrary",id:"30"},
        {name:"clevnet",id:"31"},
        {name:"marmot",id:"32"},
        {name:"metrolibrary",id:"33"},
        {name:"mdpls",id:"34"},
        {name:"mcpl",id:"35"},
        {name:"mlc",id:"36"},
        {name:"minuteman",id:"37"},
        {name:"molib2go",id:"38"},
        {name:"mcplmd",id:"39"},
        {name:"multcolib",id:"40"},
        {name:"mvlc",id:"41"},
        {name:"nashville",id:"42"},
        {name:"netldc",id:"43"},
        {name:"nm",id:"44"},
        {name:"noble",id:"45"},
        {name:"nypl",id:"46"},
        {name:"ocln",id:"47"},
        {name:"piercecounty",id:"48"},
        {name:"ppld",id:"49"},
        {name:"queenslibrary",id:"50"},
        {name:"sails",id:"51"},
        {name:"sanantonio",id:"52"},
        {name:"sfpl",id:"53"},
        {name:"santaclara",id:"54"},
        {name:"springfield",id:"55"},
        {name:"slc",id:"56"},
        {name:"timberland",id:"57"},
        {name:"reads",id:"58"},
        {name:"toledo",id:"59"},
        {name:"toronto",id:"60"},
        {name:"clc",id:"61"},
        {name:"wccls",id:"62"},
        {name:"wplc",id:"63"},
        {name:"wvdeli",id:"64"},
        {name:"mobius",id:"65"},
        {name:"xenos",id:"66"},
    ]
    
    let specialBooks = {
        "1007711": "Book is currently WIP.",
        "1175788": "Book is currently WIP.",
        "121810": "Book is currently WIP.",
        "1643433": "Book is currently WIP.",
        "1643449": "Book is currently WIP.",
        "169302": "Book is currently WIP.",
        "2121768": "Book is currently WIP.",
        "2394203": "Book is currently WIP.",
        "2543235": "Book is currently WIP.",
        "3044181": "Book is currently WIP.",
        "310503": "Book is currently WIP.",
        "3471012": "Book is currently WIP.",
        "4198676": "Book is currently WIP.",
        "4322878": "Book is currently WIP.",
        "4404045": "Book is currently WIP.",
        "4523920": "Book is currently WIP.",
        "5072581": "Book is currently WIP.",
        "5263799": "Book is currently WIP.",
        "5335291": "Book is currently WIP.",
        "5459837": "Book is currently WIP.",
        "5459838": "Book is currently WIP.",
        "5643505": "Book is currently WIP.",
        "5754707": "Book is currently WIP.",
        "799999": "Book is currently WIP",
        "5363520": "Book is currently WIP",
    }
</script>

<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SearchLibNet</title>


<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jq-3.3.1/dt-1.10.23/fc-3.3.2/sc-2.0.3/datatables.min.css"/>
 
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.3.1/dt-1.10.23/fc-3.3.2/sc-2.0.3/datatables.min.js"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<script src="https://gitcdn.link/repo/masotime/json-url/master/dist/browser/json-url.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>

</head>
<body>
    <div id="Search" style="display:block">
        <section id="cover">
            <div id="cover-caption">
                <div class="container">
                    <div class="row text-white">
                        <div class="col-xl-5 col-lg-6 col-md-8 col-sm-10 mx-auto text-center form p-4">
                            <h1 class="display-4 py-2 text-truncate text-dark">SearchLibNet</h1>
                            <div class="px-2">
                                <form action="" class="justify-content-center" onsubmit="return false;" method="post">
                                    <div class="form-group">
                                        <label class="sr-only">Book ID</label>
                                        <input id="bookID"  class="form-control" name="bookID" type="number" value="" placeholder="Enter a book id. eg.. 1044984" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-lg" onclick="searchBooks()">Search</button>
                                    <div id="response" class="pt-2 text-muted">Waiting to search..</div>
                                    <div id="urlBox" style="display:none" class="pt-3">
          
                                        
                                        <div class="input-group" onclick="copyToClip()">
                                            <input class="ml-auto" id="urlArea" type="text" value="https://github.com/zenorocha/clipboard.js.git">
                                            <span class="input-group-button mr-auto" >
                                                <button class="copyBtn" type="button" >
                                                    <img class="clippy" src="https://clipboardjs.com/assets/images/clippy.svg" alt="Copy to clipboard" width="13">
                                                </button>
                                            </span>
                                        </div>

                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>
    
    <div id="Display"  class="m-4">
        <table id="bookSearch" class="display" width="100%"></table>
    </div>



</body>
<style>
    .input-group-button {
        width: 1%;
        vertical-align: middle;
    }
    .copyBtn {
        position: relative;
        display: inline-block;
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 700;
        line-height: 20px;
        color: #333;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        background-color: #eee;
        background-image: linear-gradient(#fcfcfc,#eee);
        border: 1px solid #d5d5d5;
        border-radius: 3px;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;

    }
</style>

<script>
const libJson = JsonUrl('lzma');
let foundURL = null
const queryString = window.location.search;
const urlParams = new URLSearchParams(window.location.search);
const data = urlParams.get('data')

function displayData(data){
    libJson.decompress(data).then((decompressed)=>{
        let jsonData = JSON.parse(decompressed)
        let info = jsonData.pop()
        for (let i = 0; i < jsonData.length; i++) {
            let result = Locations.find(obj => {return obj.id === jsonData[i][0]})   
            jsonData[i][0] = `<a href="https://${result.name}.overdrive.com/media/${info.id}">${result.name}</a>`
            //jsonData[i].push(`<a href="https://${result.name}.overdrive.com/media/${info.id}">${info.name}</a>`)
        }
        
        const myUrl = new URL(window.location.href);
        myUrl.searchParams.delete("data")
        myUrl.searchParams.append("data", data);

        document.getElementById("response").innerHTML = `Found "${info.name}" at ${jsonData.length} locations`
        document.getElementById("urlBox").style.display = "block";
        document.getElementById("urlArea").value = myUrl.href
        document.getElementById("bookID").value = info.id

        let table = $('#bookSearch').DataTable( {
            destroy: true,
            data: jsonData,
            scrollY:       400,
            scrollX:        true,
            scrollCollapse: true,
            deferRender:    true,
            scroller: true,
            "order": [[ 1, 'desc' ], [ 2, 'desc' ], [ 3, 'desc' ]],
            columns: [
                { title: "Library" ,type: "html"},
                { title: "Available" },
                { title: "Copies" },
                { title: "WaitDays." },
                //{ title: "Link." ,type: "html"},
            ]
        });
        new $.fn.dataTable.FixedColumns( table );
    })
}

if(data){ 
    document.getElementById("Display").style.display = "block";
    displayData(data)
}

function copyToClip() {


    var copy = function(elementId) {
    var input = document.getElementById(elementId);
    var isiOSDevice = navigator.userAgent.match(/ipad|iphone/i);

    if (isiOSDevice) {
    
        var editable = input.contentEditable;
        var readOnly = input.readOnly;

        input.contentEditable = true;
        input.readOnly = false;

        var range = document.createRange();
        range.selectNodeContents(input);

        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        input.setSelectionRange(0, 999999);
        input.contentEditable = editable;
        input.readOnly = readOnly;

    } else {
        input.select();
    }

document.execCommand('copy');
}


    copy("urlArea")

    toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-bottom-right",
    "showDuration": "300",
    "hideDuration": "200",
    "timeOut": "2000",
    "extendedTimeOut": "1000",
    }
    toastr["success"]("Saved to clipboard")
}

async function searchBooks(){
    window.history.replaceState(null, null, window.location.pathname);
    document.getElementById("urlBox").style.display = "none";
    document.getElementById("Display").style.display = "none";
    let book = document.getElementById("bookID").value;

    if(specialBooks.hasOwnProperty(book)){
        document.getElementById("response").innerHTML = specialBooks[book]
        return
    }
    document.getElementById("response").innerHTML = `Searching for the book: ${book}`
    let allLocations = []
    let allPromises = []
    for (const location of Locations) {
        const url = new URL(`https://${location.name}.overdrive.com/media/info/${book}`);
        const proxy = "https://cors.corsb4.workers.dev?"
        async function getAxios(url,location){
            try {
                return {resp:await axios.get(url), id:location.id, name:location.name, book} 
            } catch (error) {
                
            }
            
        }
        allPromises.push(getAxios(proxy+url.href,location))
    }
    let result = await Promise.all(allPromises)
    let bookName = null
    for (const lib of result) {
        if(!lib) continue;
        if(!bookName) bookName = lib.resp.data.title
        if(!lib.resp.data.isOwned) continue;


        let data = [
            lib.id,
            lib.resp.data.isAvailable,
            lib.resp.data.hasOwnProperty("availableCopies") ? lib.resp.data.availableCopies : false,
            lib.resp.data.hasOwnProperty("estimatedWaitDays") ? lib.resp.data.estimatedWaitDays : false,
        ]
        allLocations.push(data)
    }
    
    
    //window.history.pushState("", "", window.location.href);
   
    if(bookName){

        if(!allLocations.length){
            document.getElementById("response").innerHTML = `Book: "${bookName}" wasn't found at any location.`
        }else{

            allLocations.push({name:bookName,id:book})
            const myUrl = new URL(window.location.href);
            let compressed = await libJson.compress(JSON.stringify(allLocations))
            myUrl.searchParams.delete("data")
            myUrl.searchParams.append("data", compressed);
            document.getElementById("urlBox").style.display = "block";
            document.getElementById("urlArea").value = myUrl.href
            document.getElementById("response").innerHTML = `Found "${bookName}" at ${allLocations.length-1} locations`
            //window.history.pushState("", "", myUrl.href);
            window.history.replaceState(null, null, myUrl.href);

            document.getElementById("Display").style.display = "block";
            displayData(compressed)
            
        }
    }else{
        document.getElementById("response").innerHTML = `Book: ${book} not found.`
    }
    

}



</script>

</html>
